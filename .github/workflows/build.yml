name: "Run tests and lints"
on:
  - push
jobs:
  build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_USER: koala
        ports:
          - 25838:5432

    env:
      DATABASE_HOST: "127.0.0.1"
      DATABASE_USER: koala
      DATABASE_PASSWORD: password
      DATABASE_PORT: 25838
      OIDC_SIGNING_KEY: .github/test-signing-key.pem

    steps:
    - uses: "actions/checkout@v3"

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          node_modules
          /usr/local/bundle
        key: koala

    - name: "install system dependencies"
      run: sudo apt-get install -y nodejs ghostscript mupdf yarn postgresql-client bundler

    - name: "install rails dependencies"
      run: bundle install

    - name: "install node dependencies"
      run: yarn install

    - name: "Execute Haml linter"
      run: bundle exec haml-lint

    - name: "Execute Javascript linter"
      run: npx prettier -c app/javascript/*

    - name: "Check for security vulnerabilities"
      run: bundle exec brakeman

    - name: "create database"
      run: rails db:create --trace

    - name: Start Redis
      uses: supercharge/redis-github-action@1.1.0
      with:
        redis-version: 5

    - name: "setup database"
      run: rails db:setup --trace

    - name: "run tests"
      run: bundle exec rake
